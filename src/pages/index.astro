---
import "../styles/global.css";
import PostCard from "@/components/PostCard.astro";
import Navbar from "@/components/Navbar.astro";
import ProfileAvatar from "@/components/ProfileAvatar.tsx";
import DiscordPopover from "@/components/DiscordPopover.tsx";
import Footer from "@/components/Footer.astro";
import ThemeScript from "@/components/ThemeScript.astro";

const allPosts = await Astro.glob("./posts/*.md");

// Separate sticky and non-sticky posts
const stickyPosts = allPosts.filter((post) => post.frontmatter.sticky === true);
const nonStickyPosts = allPosts.filter(
  (post) => post.frontmatter.sticky !== true,
);

// Sort both arrays by date (newest first)
const sortByDate = (a: any, b: any) => {
  const dateA = new Date(a.frontmatter.date || 0);
  const dateB = new Date(b.frontmatter.date || 0);
  return dateB.getTime() - dateA.getTime();
};

const sortedStickyPosts = stickyPosts.sort(sortByDate);
const sortedNonStickyPosts = nonStickyPosts.sort(sortByDate);

const emojis = ["👹", "👺", "👻", "💣", "🧠", "👀", "🐙", "🐧", "🥑"];
const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>Layle's Lair</title>
    <ThemeScript />
  </head>

  <body>
    <Navbar />

    <div class="max-w-4xl mx-auto px-4 py-8">
      <h1 class="text-4xl font-bold mb-6">Greetings, traveller 👋</h1>
      <div class="flex items-start gap-6">
        <p class="text-lg text-muted-foreground flex-1">
          This is my personal blog where you'll find me rambling about all sorts
          of topics. I usually talk about reverse engineering, security research
          and emulators. Enjoy your stay! {randomEmoji}
        </p>
        <div class="flex-shrink-0">
          <ProfileAvatar client:load />
        </div>
      </div>
      <div class="flex items-center gap-4 mt-4">
        <!-- GitHub Link -->
        <a
          href="https://github.com/ioncodes"
          target="_blank"
          rel="noopener noreferrer"
          class="text-muted-foreground social-button"
          aria-label="GitHub Profile"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-6 h-6"
          >
            <path
              d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
            ></path>
          </svg>
        </a>

        <!-- Discord Username -->
        <DiscordPopover
          client:load
          className="text-muted-foreground social-button cursor-pointer"
          iconSize="large"
        />

        <!-- Twitter/X Link -->
        <a
          href="https://twitter.com/layle_ctf"
          target="_blank"
          rel="noopener noreferrer"
          class="text-muted-foreground social-button"
          aria-label="Twitter Profile"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-6 h-6"
          >
            <path
              d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"
            ></path>
          </svg>
        </a>

        <!-- Bluesky Link -->
        <a
          href="https://bsky.app/profile/layle.bsky.social"
          target="_blank"
          rel="noopener noreferrer"
          class="text-muted-foreground social-button"
          aria-label="Bluesky Profile"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 360 320"
            fill="currentColor"
            class="w-6 h-6"
          >
            <path
              d="M180 141.964C163.699 110.262 119.308 51.1817 78.0347 22.044C38.4971 -5.86834 23.414 -1.03207 13.526 3.43594C2.08093 8.60755 0 26.1785 0 36.5164C0 46.8542 5.66748 121.272 9.36416 133.694C21.5786 174.738 65.0603 188.607 105.104 184.156C107.151 183.852 109.227 183.572 111.329 183.312C109.267 183.642 107.19 183.924 105.104 184.156C46.4204 192.847 -5.69621 214.233 62.6582 290.33C137.848 368.18 165.705 273.637 180 225.702C194.295 273.637 210.76 364.771 295.995 290.33C360 225.702 313.58 192.85 254.896 184.158C252.81 183.926 250.733 183.645 248.671 183.315C250.773 183.574 252.849 183.855 254.896 184.158C294.94 188.61 338.421 174.74 350.636 133.697C354.333 121.275 360 46.8568 360 36.519C360 26.1811 357.919 8.61012 346.474 3.43851C336.586 -1.02949 321.503 -5.86576 281.965 22.0466C240.692 51.1843 196.301 110.262 180 141.964Z"
            ></path>
          </svg>
        </a>
      </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
      {
        sortedStickyPosts.length > 0 && (
          <div class="grid grid-cols-1 gap-4">
            {sortedStickyPosts.map((post) => (
              <PostCard post={post} isSticky={true} />
            ))}
          </div>
        )
      }

      <div class="flex justify-center py-4">
        <div class="w-128 h-px bg-border"></div>
      </div>

      {
        sortedNonStickyPosts.length > 0 && (
          <div class="grid grid-cols-1 gap-4">
            {sortedNonStickyPosts.map((post) => (
              <PostCard post={post} />
            ))}
          </div>
        )
      }

      {
        sortedNonStickyPosts.length === 0 && sortedStickyPosts.length == 0 && (
          <div class="text-center">
            <p class="text-muted-foreground">No posts found.</p>
          </div>
        )
      }
    </div>

    <Footer />
  </body>
</html>
